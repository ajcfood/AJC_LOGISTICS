USE [MGXMLProcessing]
GO
/****** Object:  StoredProcedure [dbo].[sp-MGXML-LoadOracleRecs]    Script Date: 5/21/2019 2:42:33 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





ALTER PROCEDURE [dbo].[sp-MGXML-LoadOracleRecs](@ORCLENV CHAR(15), @ORCLTBL CHAR(30))

AS
BEGIN TRY
BEGIN

SET NOCOUNT ON;

/*
05/17/2019 - SA - Added Error Logging

*/

DECLARE @SQL1 NVARCHAR(MAX),
	  @SQL2 NVARCHAR(MAX),
	  @SQL3 NVARCHAR(MAX);


SET @SQL1 = '
insert into
openquery(' + @ORCLENV + ', ''select * from ' + @ORCLTBL + ''')
select [RefShippingOrder]
      ,[RefLoadID]
      ,[RefReleaseNum]
      ,[RefPONum]
      ,[RefSCAC]
      ,[CarrierID]
      ,[CarrierName]
      ,[EnterpriseName]
      ,[EnterpriseParentName]
      ,[EnterpriseType]
      ,[EnterpriseAccntNum]
      ,[PriceSheetType]
      ,[PriceSheetCurrency]
      ,[PriceSheetCreatedBy]
      ,[PriceSheetUpdatedBy]
      ,[PriceSheetDateCategory]
      ,[PriceSheetPickupDate]
      ,[PriceSheetDropDate]
      ,[ChargesType]
      ,[ChargesSeqNum]
      ,[ChargesEDICode]
      ,[ChargesDesc]
      ,[ChargesAmount]
      ,[InvNum]
      ,[InvDate]
      ,[LoadedDateTime]
      ,[FileName]
      ,[FileCreatedDate]
from [MGXMLProcessing].[dbo].[tblCarrierXML_InvoiceLoadRecs] where [SentToOracle] = 0';

EXEC sp_executesql @SQL1;


update [MGXMLProcessing].[dbo].[tblCarrierXML_InvoiceLoadRecs]
set [SentToOracle] = 1
where [SentToOracle] = 0;


/*
-- Insert Carrier Records Into Oracle Staging Interface Table --
----------------------------------------------------------------
insert into
openquery(finupg5, 'select * from MG_CARRIERXML_INVOICERECS')
select [RefShippingOrder]
      ,[RefLoadID]
      ,[RefReleaseNum]
      ,[RefPONum]
      ,[RefSCAC]
      ,[CarrierID]
      ,[CarrierName]
      ,[EnterpriseName]
      ,[EnterpriseParentName]
      ,[EnterpriseType]
      ,[EnterpriseAccntNum]
      ,[PriceSheetType]
      ,[PriceSheetCurrency]
      ,[PriceSheetCreatedBy]
      ,[PriceSheetUpdatedBy]
      ,[PriceSheetDateCategory]
      ,[PriceSheetPickupDate]
      ,[PriceSheetDropDate]
      ,[ChargesType]
      ,[ChargesSeqNum]
      ,[ChargesEDICode]
      ,[ChargesDesc]
      ,[ChargesAmount]
      ,[InvNum]
      ,[InvDate]
      ,[LoadedDateTime]
      ,[FileName]
      ,[FileCreatedDate]
from [MGXMLProcessing].[dbo].[tblCarrierXML_InvoiceLoadRecs] where [SentToOracle] = 0;

update [MGXMLProcessing].[dbo].[tblCarrierXML_InvoiceLoadRecs]
set [SentToOracle] = 1
where [SentToOracle] = 0;


-- Insert Customer Records Into Oracle Staging Interface Table --
-----------------------------------------------------------------
insert into
openquery(finupg5, 'select * from MG_CUSTOMERXML_INVOICERECS')
select [RefShippingOrder]
      ,[RefLoadID]
      ,[RefReleaseNum]
      ,[RefPONum]
      ,[RefSCAC]
      ,[EnterpriseName]
      ,[EnterpriseParentName]
      ,[EnterpriseType]
      ,[EnterpriseAccntNum]
      ,[PriceSheetType]
      ,[PriceSheetCurrency]
      ,[PriceSheetCreatedBy]
      ,[PriceSheetUpdatedBy]
      ,[PriceSheetDateCategory]
      ,[PriceSheetPickupDate]
      ,[PriceSheetDropDate]
      ,[ChargesType]
      ,[ChargesSeqNum]
      ,[ChargesEDICode]
      ,[ChargesDesc]
      ,[ChargesAmount]
      ,[InvNum]
      ,[InvDate]
      ,[LoadedDateTime]
      ,[FileName]
      ,[FileCreatedDate]
from [MGXMLProcessing].[dbo].[tblCustomerXML_InvoiceLoadRecs] where [SentToOracle] = 0;

update [MGXMLProcessing].[dbo].[tblCustomerXML_InvoiceLoadRecs]
set [SentToOracle] = 1
where [SentToOracle] = 0;


-- Insert Route Records Into Oracle Staging Interface Table --
--------------------------------------------------------------
insert into
openquery(finupg5, 'select * from MG_ROUTEXML_TRANSPORTRECS')
select [RefShippingOrder]
      ,[RefLoadID]
      ,[RefReleaseNum]
      ,[RefPONum]
      ,[RefSCAC]
      ,[CarrierID]
      ,[CarrierName]
      ,[RefCustomerAcctNum]
      ,[PriceSheetType]
      ,[PriceSheetCurrency]
      ,[PriceSheetCreatedBy]
      ,[PriceSheetUpdatedBy]
      ,[PriceSheetDateCategory]
      ,[PriceSheetPickupDate]
      ,[PriceSheetDropDate]
      ,[ChargesType]
      ,[ChargesSeqNum]
      ,[ChargesEDICode]
      ,[ChargesDesc]
      ,[ChargesAmount]
      ,[LoadedDateTime]
      ,[FileName]
      ,[FileCreatedDate]
from [MGXMLProcessing].[dbo].[tblRouteXML_TransportLoadRecs] where [SentToOracle] = 0;

update [MGXMLProcessing].[dbo].[tblRouteXML_TransportLoadRecs]
set [SentToOracle] = 1
where [SentToOracle] = 0;
*/

END
End Try



BEGIN CATCH


              DECLARE @ErrorMessage NVARCHAR(4000), @ErrorLine INT, @ErrorDate DATETIME;

              
              SELECT @ErrorMessage = ERROR_MESSAGE(), @ErrorLine = ERROR_LINE(), @ErrorDate = GETDATE();
              
              Insert into AJCDW.dbo.tblProcedureErrorLog ([ProcedureName], [ErrorMessage], [ErrorLine], [ErrorDate])
              Select '[sp-MGXML-LoadOracleRecs]', @ErrorMessage, @ErrorLine, @ErrorDate



END CATCH
